<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Camera Capture</title>
	</head>
	<body>
		<h1>Camera Capture</h1>
		<video id="video" width="640" height="480" autoplay></video>
		<button id="capture">Capture</button>
		<canvas id="canvas" width="640" height="480" style="display: none"></canvas>
		<div>
			<label for="rfid">RFID:</label>
			<input type="text" id="rfid" name="rfid" />
			<button id="send">Send</button>
		</div>
		<script>
			const sendButton = document.getElementById('send');
			const rfidInput = document.getElementById('rfid');

			sendButton.addEventListener('click', () => {
				const rfid = rfidInput.value;
				fetch('http://192.168.1.210:3000/api/security-gate/auth-door', {
					method: 'POST',
					body: rfid,
				})
					.then((response) => response.json())
					.then((data) => {
						console.log('Success:', data);
					})
					.catch((error) => {
						console.error('Error:', error);
					});
			});
		</script>

		<script>
			const ADDRESS =
				'ws://192.168.1.210:3000?source=esp32cam_security_gate_send_img';
			const video = document.getElementById('video');
			const canvas = document.getElementById('canvas');
			const captureButton = document.getElementById('capture');
			const context = canvas.getContext('2d');
			const websocket = new WebSocket(ADDRESS);

			// Get access to the camera
			navigator.mediaDevices
				.getUserMedia({ video: true })
				.then((stream) => {
					video.srcObject = stream;
				})
				.catch((err) => {
					console.error('Error accessing the camera: ', err);
				});

			websocket.onopen = async () => {
				console.log('WebSocket connection opened');

				setInterval(() => {
					context.drawImage(video, 0, 0, canvas.width, canvas.height);
					const imageData = canvas.toDataURL('image/jpeg');
					const binary = atob(imageData.split(',')[1]);
					const array = new Uint8Array(binary.length);
					for (let i = 0; i < binary.length; i++) {
						array[i] = binary.charCodeAt(i);
					}
					websocket.send(array.buffer);
				}, 1000 / 24);
			};

			websocket.onclose = () => {
				console.log('WebSocket connection closed');
			};

			websocket.onerror = (error) => {
				console.error('WebSocket error: ', error);
			};
		</script>
	</body>
</html>
